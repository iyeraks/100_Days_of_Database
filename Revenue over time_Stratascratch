Find the 3-month rolling average of total revenue from purchases given a table with users, their purchase amount, and date purchased. Do not include returns which are represented by negative purchase values. Output the year-month (YYYY-MM) and 3-month rolling average of revenue, sorted from earliest month to latest month.


A 3-month rolling average is defined by calculating the average total revenue from all user purchases for the current month and previous two months. The first two months will not be a true 3-month rolling average since we are not given data from last year. Assume each month has at least one purchase.

------- Output -------------

with monthly_revenue as (
select 
    date_trunc('month',created_at) as year_month,
    sum(case when purchase_amt > 0 then purchase_amt else 0 end) as total_revenue
    from amazon_purchases
    group by 
    date_trunc('month',created_at)
),
rolling_average as (
select 
    year_month,
    total_revenue,
    avg(total_revenue) over (order by year_month rows between 2 preceding and current row) as rol_avg
    from 
    monthly_revenue
    
)
select 
    to_char(year_month,'YYYY-MM') as year_month,
    round(rol_avg,2) as revenue_3month_avg
    from 
    rolling_average
    order by year_month
